<style>
        * {
  margin: 0;
  padding: 0;
    }

.overlay {
     visibility: hidden;
     position: absolute;
     left: 0px;
     top: 0px;
     width:100%;
     height:100%;
     text-align:center;
     z-index: 1000;
}

.overlay div {
     width:300px;
     margin: 100px auto;
     background-color: #fff;
     border:1px solid #000;
     padding:15px;
     text-align:center;
}
</style>

<div class="overlay" id="overlay1">
    <div>
        <p>Изменение параметров теней</p>
        <p>
            Тип:
            <select id="type">
                <option value="HARD">HARD</option>
                <option value="PCF"selected>PCF</option>
                <option value="VSM">VSM</option>
                <option value="BLURED_VSM">Размытый VSM</option>
            </select>
        </p>
        <p>Размытие: <input id="blur" type="number" value="1" min="1" /></p>
        <p>
            Бит на канал:
            <select id="bits">
                <option selected value="1">2</option>
                <option value="4">4</option>
                <option value="8">8</option>
            </select>
        </p>
        <p>
            Кодировать текстуру:
            <select id="code">
                <option selected value="true">Да</option>
                <option value="false">Нет</option>
            </select>
        </p>
        <a href='#' onclick='overlay1();'>Применить</a>
    </div>
</div>
<div class="overlay" id="overlay2">
    <div>
        <p>Изменение параметров света</p>
        <p>Разрешение: <input id="res" type="number" value="1024" min="2" /></p>
        <p>BIAS: <input id="bias" type="range" max="0.5" min="0" step="0.0001" value="0.0027" onchange="document.getElementById('biass').innerHTML=this.value" /><b id="biass"></b></p>
        <p>Normal BIAS: <input id="normalBias" type="range" max="0.5" min="0" step="0.01" value="0.0" onchange="document.getElementById('normalbiass').innerHTML=this.value" /><b id="normalbiass"></b></p>
        <a href='#' onclick='overlay2();'>Применить</a>
    </div>
</div>
<canvas id="canv"></canvas>
<script src="collada.js"></script>
<script src="stats.js">
</script>
<script src="gl-matrix-min.js"></script>
<script src="kelios.js"></script>

<script>

    var gl = new kelios("canv", {
        anisotropic: 0
    });
    var camera = gl.createCamera([0, 1, 5], [-75, 0, 0], { type: "perspective", aspect: 0, angle: 60, nearPlane: 1, farPlane: 100 });
    var scene = gl.createScene({
        shadowSetting: {
            type: gl.VSM,
            blurScale: 4,
            bitsPerChanel: 2,
            splitForDirectionLight: 1,
            encodeTexture: true,
            IOQWAIIS: false,
            devideTexture: true//for Blured VSM
        },
        sceneParam: { autoResize: true, width: gl.width, height: gl.height }
    });
    scene.addCamera("testCamera1", camera);
    var light = gl.createLight("direction", { position: [0, 0, 0], direction: [0, 20, 45], color: [1, 1, 1], emission: 0.4 },
    {
        enable: true,
        size: 1024,
        bias: 0.002, normalBias: 0.00,
        camera: camera,
        distantion: 8,
        koef: 0.8,
        ds: 2
    });
    scene.addLight(light);
    var light2 = gl.createLight("direction", { position: [0, 0, 0], direction: [45, 0, 0], color: [1, 1, 1], emission: 0.4 },
    {
        enable: true,
        size:1024,
        bias: 0.002, normalBias: 0.00,
        camera: camera,
        distantion: 8,
        koef: 0.8,
        ds: 2
    });
    scene.addLight(light2);
    var p = [], elementName = [];
    var mat1 = gl.createMaterial([
        { type: "shader.diffuse", value1: [1, 1, 1, 1], value2: 0.0, id: 0 },
        { type: "out.out", input: 0, id: 1 }
    ]);
    var plane1 = gl.createElement({ vertex: gl.plane.vertex, index: gl.plane.index, normal: gl.plane.normal }, []);
    var mat2 = gl.createMaterial([
        { type: "texture.texture", value: "lordTextures/tex_specular_2048.jpg", id: 0 },
        { type: "texture.texture", value: "lordTextures/tex_glossiness_2048.jpg", id: 1 },
        { type: "color.color", value: [-0.1,0,0, 1], id: 2 },
        { type: "color.sum", input1: 1, input2: 2, id: 3 },
        { type: "texture.texture", value: "lordTextures/diffuse_2048.jpg", id: 4},
        { type: "texture.texture", value: "lordTextures/tex_normal_d_2048.png", id: 5 },
        { type: "vector.normalMap", input: 5, value: 1.8, id: 6 },
        { type: "shader.diffuse", input1: 4, value2: 0.0, normal:6, id: 7 },
        { type: "shader.specular", input1: 0, input2: 3,value3:0.6, id: 8 },
        { type: "shader.sum", input1: 7, input2: 8, id: 9 },
        { type: "texture.texture", value: "lordTextures/starlord_ao2_occlusion3.png", id: 10 },
        { type: "shader.ao", input1: 10, input2:9, value:1, id: 11 },
        { type: "shader.gammaCorrection", input: 11, value: 1.15, id: 12 },
    
        { type: "texture.texture", value: "lordTextures/tex_emissive_2048.jpg", id: 13 },
        { type: "shader.emission", input: 13, value: 1.5, id: 14 },
    
        { type: "shader.sum", input1: 14, input2: 12, id: 15 },
        { type: "out.out", input: 15, id: 16 }
    ]);
    p.push(mat1);
    p.push(mat2);
    var stats = new Stats();
    stats.setMode(0); // 0: fps, 1: ms, 2: mb

    stats.domElement.style.position = 'absolute';
    stats.domElement.style.left = '0px';
    stats.domElement.style.top = '0px';

    document.body.appendChild(stats.domElement);

    gl.getJson("lordUV.json", function (data) {
        //console.log(data);
        var el = gl.createElement({
            vertex: data.model.vertices[0].position.data,
            index: data.model.meshes[0].indices,
            normal: data.model.vertices[0].normal.data,
            uv: data.model.vertices[0].texCoord0.data
        }, []);
        scene.addMesh("lordHead", el, { size: [0.0177, 0.0177, 0.0177], rotate: [0, -90, 0], position: [0, 0, 0] }, mat2);
        //scene.addMesh("lordHead2", el, { size: [0.0177, 0.0177, 0.0177], rotate: [0, -90, 0], position: [-4, 0, -5.5] }, mat1);
        scene.addMesh("plane1", plane1, { size: [100, 100, 100], rotate: [0, 0, 0], position: [0, -1.5, 0] }, mat1);
        gl.assembly(scene, p);

        var anim = function () {
            stats.begin();
            //scene.rotateMesh("lordHead", [0, 0.3, 0]);
            scene.draw();
            stats.end();

            requestAnimationFrame(anim);
        }
        anim();

        gl.keyboard.keyDown = function (key) {
            if (key == "1") {
                overlay1();
                scene.draw();
            }
            if (key == "2") {
                overlay2();
                scene.draw();
            }
        }
        /*gl.mouse.mouseDrag = function (mouse) {
            console.log(mouse)
        }*/
    });


    function overlay1() {
        el = document.getElementById("overlay1");
        el.style.visibility = (el.style.visibility == "visible") ? "hidden" : "visible";
        document.getElementById("overlay2").style.visibility = "hidden";
        if (el.style.visibility == "hidden") {
            scene.updateShadowSetting({
                type: gl[document.getElementById("type").value],
                blurScale: document.getElementById("blur").value,
                bitsPerChanel: document.getElementById("bits").value,
                splitForDirectionLight: 1,
                encodeTexture: document.getElementById("code").value,
                IOQWAIIS: false,
                devideTexture: false
            });
            scene.updateShadow();
            gl.assembly(scene, p);
        }
    }
    function overlay2() {
        el = document.getElementById("overlay2");
        el.style.visibility = (el.style.visibility == "visible") ? "hidden" : "visible";
        document.getElementById("overlay1").style.visibility = "hidden";
        if (el.style.visibility == "hidden") {
            console.log(light.shadowOption)
            light.shadowOption.size = document.getElementById("res").value;
            light.shadowOption.bias = document.getElementById("bias").value;
            light.shadowOption.normalBias = document.getElementById("normalBias").value;
            light2.shadowOption.size = document.getElementById("res").value;
            light2.shadowOption.bias = document.getElementById("bias").value;
            light2.shadowOption.normalBias = document.getElementById("normalBias").value;
            scene.updateShadow();
            gl.assembly(scene, p);
        }
    }

</script>